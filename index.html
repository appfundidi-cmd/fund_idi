<script>
  // Año actual en el footer
  document.getElementById("currentYear").textContent = new Date().getFullYear();

  let geoData = {};
  let captchaSolution = 0;

  // Cargar los datos geográficos una sola vez
  async function loadGeoData() {
    try {
      // *** CORRECCIÓN: uso de ruta relativa válida y manejo seguro ***
      const response = await fetch("./geodata.json");
      if (!response.ok) throw new Error(`Error HTTP ${response.status} al cargar geodata.json`);
      geoData = await response.json();
      console.log("geodata.json cargado correctamente");
    } catch (error) {
      console.error("Error crítico al cargar geodata.json:", error);
      geoData = { departamentos: [] }; // estructura vacía para fallback seguro
    }
    return geoData;
  }

  // Espera de carga
  const geoDataPromise = loadGeoData();

  // -----------------------------------------------------------------
  // (El resto de tu código original no se modifica en absoluto)
  // -----------------------------------------------------------------

  const selectionContainer = document.getElementById("selection-container");
  const formContainer = document.getElementById("form-container");
  const selectNatural = document.getElementById("select-natural");
  const selectJuridica = document.getElementById("select-juridica");

  async function showForm(formHTML) {
    selectionContainer.classList.add("hidden");
    formContainer.innerHTML = formHTML;
    formContainer.classList.remove("hidden");
    window.scrollTo({ top: 0, behavior: "smooth" });

    // *** CORRECCIÓN: asegura que geodata esté disponible antes de llamar setupGeoFields ***
    await geoDataPromise;
    setupGeoFields();
  }

  function setupGeoFields() {
    const paisSelect = document.getElementById("pais");
    const departamentoSelect = document.getElementById("departamento");
    const ciudadSelect = document.getElementById("ciudad");

    if (!geoData || !geoData.departamentos) {
      console.error("geodata.json no contiene la estructura esperada.");
      return;
    }

    departamentoSelect.innerHTML = '<option value="">Seleccione...</option>';
    geoData.departamentos.forEach((d) => {
      const option = document.createElement("option");
      option.value = d.departamento;
      option.textContent = d.departamento;
      departamentoSelect.appendChild(option);
    });

    departamentoSelect.addEventListener("change", () => {
      const selectedDept = geoData.departamentos.find(
        (dep) => dep.departamento === departamentoSelect.value
      );
      ciudadSelect.innerHTML = '<option value="">Seleccione...</option>';
      if (selectedDept) {
        selectedDept.ciudades.forEach((city) => {
          const option = document.createElement("option");
          option.value = city;
          option.textContent = city;
          ciudadSelect.appendChild(option);
        });
      }
    });
  }

  // (Aquí sigue exactamente todo tu código original del CAPTCHA, drag & drop, envío, etc.)
</script>
